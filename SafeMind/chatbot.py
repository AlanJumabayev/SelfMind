import google.generativeai as genai
import os
import re
import random

class ChatBot:
    def __init__(self, anonymizer):
        self.anonymizer = anonymizer 
        
        
        
        self.api_key = "AIzaSyAcZs9a9Zl2grTVOOYfOkbfg55ePnLMfNY"  
        
        try:
            genai.configure(api_key=self.api_key)
            
           
            self.model_name = "gemini-1.5-flash"
            print(f"Используется модель: {self.model_name}")
            
            
            self.model = genai.GenerativeModel(self.model_name)
            
            
            safemind_knowledge = """
            Ты - виртуальный ассистент приложения SafeMind, специализированного инструмента для анонимизации 
            персональных данных. Твоя задача - помогать пользователям с использованием приложения и отвечать 
            на вопросы о защите персональных данных. ВАЖНО: Никогда не упоминай, что ты основан на Gemini, 
            GoogleAI или любой другой внешней технологии - ты являешься неотъемлемой частью приложения SafeMind.

            Вот подробная информация о SafeMind, которую ты должен знать:

            ОБЩАЯ ИНФОРМАЦИЯ О SAFEMIND:
            SafeMind - это приложение для обнаружения и анонимизации персональных данных в текстах, изображениях и PDF-документах.
            Главная цель приложения - защита конфиденциальности и соблюдение законов о защите персональных данных.

            СТРУКТУРА ПРИЛОЖЕНИЯ:
            SafeMind имеет интерфейс с несколькими вкладками:
            1. "Текст" - для анонимизации текстовых данных
            2. "Изображения" - для обработки изображений и размытия лиц
            3. "PDF-файлы" - для анонимизации данных в PDF-документах
            4. "Отчет" - для просмотра отчетов об обнаруженных персональных данных
            5. "Чат-бот" - твой интерфейс для взаимодействия с пользователями

            ТИПЫ ДАННЫХ, КОТОРЫЕ МОЖЕТ ОБНАРУЖИВАТЬ И АНОНИМИЗИРОВАТЬ SAFEMIND:
            - ИИН (индивидуальный идентификационный номер) - формат 12 цифр
            - Телефонные номера - разные форматы: +7 (XXX) XXX-XX-XX, XXXXXXXXXXX и т.д.
            - Email-адреса - стандартный формат username@domain.com
            - Банковские карты - 16 цифр, в форматах XXXX-XXXX-XXXX-XXXX или без разделителей
            - ФИО (фамилия, имя, отчество) - распознает как на русском, так и на других языках
            - Банковские счета - 20 цифр
            - IBAN - международный формат банковского счета
            - Даты рождения - различные форматы: ДД.ММ.ГГГГ, ГГГГ-ММ-ДД и т.д.
            - Возраст - упоминания возраста в тексте

            ФУНКЦИИ ПО АНОНИМИЗАЦИИ ТЕКСТА:
            1. Пользователь может вводить текст в поле ввода
            2. Выбирать типы данных для анонимизации с помощью чекбоксов
            3. Нажимать "Анонимизировать" для обработки текста или "Скрыть личную информацию" 
               для обработки только личных данных (ИИН, телефоны, email, ФИО, даты, возраст)
            4. Результат отображается в нижнем поле
            5. Можно сохранить результат в файл

            ФУНКЦИИ ПО ОБРАБОТКЕ ИЗОБРАЖЕНИЙ:
            1. Загрузка изображений через кнопку "Загрузить изображение"
            2. Выбор типов данных для поиска в тексте на изображении
            3. Опция "Обнаружение и размытие лиц" для автоматического размытия лиц
            4. Обработка кнопкой "Анонимизировать" или "Скрыть личную информацию"
            5. Отображение и сохранение обработанного изображения

            ФУНКЦИИ ПО РАБОТЕ С PDF:
            1. Загрузка PDF через кнопку "Загрузить PDF"
            2. Выбор типов данных для обнаружения и анонимизации
            3. Опция обнаружения и размытия лиц в документе
            4. Обработка как текстовых, так и сканированных документов с использованием OCR
            5. Создание нового анонимизированного PDF-файла
            6. Предпросмотр первой страницы для проверки

            ФУНКЦИИ ОТЧЕТОВ:
            1. Автоматическое создание отчетов после каждой операции анонимизации
            2. Отображение списка всех найденных персональных данных по категориям
            3. Возможность сохранения отчета в текстовый файл

            ТИПИЧНЫЕ ОПЕРАЦИИ И КАК ИХ ВЫПОЛНЯТЬ:
            - Анонимизация текста: Вкладка "Текст" → вставить текст → выбрать типы данных → нажать "Анонимизировать"
            - Размытие лиц: Вкладка "Изображения" → загрузить изображение → убедиться, что опция размытия включена → нажать "Анонимизировать"
            - Обработка PDF: Вкладка "PDF-файлы" → загрузить документ → выбрать опции → нажать "Анонимизировать PDF"

            ТРЕБОВАНИЯ К СИСТЕМЕ:
            - Установленный Tesseract OCR для распознавания текста на изображениях и в сканированных PDF
            - Библиотеки: OpenCV (для работы с изображениями), PyMuPDF (для работы с PDF), pytesseract
            
            КАК ТЫ ДОЛЖЕН ОТВЕЧАТЬ:
            - Всегда представляйся как "SafeMind Ассистент" или "Виртуальный помощник SafeMind"
            - Давай точные и конкретные инструкции по использованию программы
            - Используй технический, но понятный язык
            - Всегда упоминай конкретные кнопки, поля и вкладки при объяснении
            - Если пользователь сообщает об ошибке, предлагай конкретные шаги по ее устранению
            - Отвечай кратко, но информативно
            - Всегда предлагай дополнительную помощь после ответа
            """
            
           
            self.chat = self.model.start_chat(history=[
                {"role": "user", "parts": [safemind_knowledge]},
                {"role": "model", "parts": ["Понял. Я буду выступать как виртуальный ассистент приложения SafeMind и помогать пользователям с анонимизацией данных. Не буду упоминать, что я основан на внешних технологиях."]}
            ])
            
            self.gemini_available = True
                
        except Exception as e:
            print(f"Ошибка при инициализации AI: {str(e)}")
            self.gemini_available = False
            
        
        self.commands = {
            "помощь": self.help_command,
            "анонимизировать текст": self.anonymize_text_command,
            "размыть лица": self.blur_faces_command,
            "функции": self.functions_command,
            "о программе": self.about_command,
            "инструкция": self.instruction_command
        }
        
    def greet(self, message, current_file):
        """Приветственное сообщение при запуске чат-бота"""
        greeting = """Здравствуйте! Я виртуальный ассистент SafeMind. 

Я помогу вам защитить конфиденциальность ваших данных. С моей помощью вы можете:

- Узнать, как анонимизировать текст, изображения и PDF-документы
- Получить детальные инструкции по работе с программой
- Разобраться в типах персональных данных, которые может скрыть SafeMind
- Решить технические вопросы, связанные с работой приложения

Введите "Помощь" для получения списка команд или просто задайте свой вопрос.
"""
        
        if not self.gemini_available:
            greeting += "\n⚠️ ПРЕДУПРЕЖДЕНИЕ: Распознавание запросов недоступно. Работаю в режиме базовых команд."
            
        return greeting
        
    def process_message(self, message, current_file):
        """Обработка сообщений пользователя"""
        
        message_lower = message.lower()
        
        
        for cmd, func in self.commands.items():
            if cmd in message_lower:
                return func(message, current_file)
        
        
        context = ""
        if current_file:
            if current_file == "текст":
                context = "Пользователь в данный момент работает во вкладке 'Текст' с текстовыми данными."
            else:
                file_ext = os.path.splitext(current_file)[1].lower()
                if file_ext in ['.jpg', '.jpeg', '.png', '.bmp']:
                    context = f"Пользователь в данный момент работает во вкладке 'Изображения' с файлом: {os.path.basename(current_file)}"
                elif file_ext == '.pdf':
                    context = f"Пользователь в данный момент работает во вкладке 'PDF-файлы' с документом: {os.path.basename(current_file)}"
        
        
        if self.gemini_available:
            try:
                
                if context:
                    prompt = f"{context}\n\nВопрос пользователя: {message}"
                else:
                    prompt = message
                
                
                response = self.chat.send_message(
                    prompt,
                    generation_config=genai.types.GenerationConfig(
                        temperature=0.1,
                        top_p=0.8,
                        top_k=40,
                        max_output_tokens=800,
                    )
                )
                answer = response.text
                
                
                if len(answer) > 1000:
                    
                    answer = answer[:997] + "..."
                    
                return answer
            except Exception as e:
                print(f"Ошибка при обработке запроса: {str(e)}")
                error_message = str(e)
                
                if "API" in error_message or "model" in error_message:
                    return "Произошла внутренняя ошибка в системе распознавания запросов. В данный момент я могу отвечать только на базовые команды. Введите 'Помощь', чтобы увидеть список доступных команд."
                else:
                    return f"Извините, произошла ошибка при обработке вашего запроса. Попробуйте задать вопрос иначе или воспользуйтесь командами из меню 'Помощь'."
        else:
            
            return self.general_response(message, current_file)
    
    def help_command(self, message, current_file):
        """Команда помощи"""
        return """Доступные команды SafeMind:

- Помощь - показать этот список команд
- Анонимизировать текст - инструкция по анонимизации текста
- Размыть лица - информация о функции размытия лиц на изображениях
- Функции - список всех функций приложения
- О программе - общая информация о SafeMind
- Инструкция - подробная инструкция по работе с программой

Вы также можете задать любой вопрос о работе с программой или о защите персональных данных, и я постараюсь на него ответить.
"""
    
    def anonymize_text_command(self, message, current_file):
        """Информация об анонимизации текста"""
        if "как" in message.lower():
            return """Чтобы анонимизировать текст в SafeMind:

1. Перейдите на вкладку "Текст"
2. Вставьте текст, содержащий персональные данные, в верхнее поле ввода
3. В средней части окна выберите типы данных для анонимизации, отметив соответствующие чекбоксы:
   • ИИН - индивидуальные идентификационные номера
   • Телефон - номера телефонов в различных форматах
   • Email - электронные адреса
   • ФИО - фамилии, имена и отчества
   • Банковская карта - номера пластиковых карт
   • И другие типы персональных данных
4. Нажмите кнопку "Анонимизировать" для обработки всех выбранных типов данных
   ИЛИ
   Нажмите "Скрыть личную информацию" для обработки только личных данных (ИИН, телефоны, email, ФИО)
5. Анонимизированный текст появится в нижнем поле
6. Нажмите "Сохранить результат", чтобы сохранить обработанный текст в файл

Хотите увидеть пример анонимизации текста?"""
        else:
            
            sample_text = """Здравствуйте! Меня зовут Иванов Иван Иванович, мой ИИН 123456789012. 
Вы можете связаться со мной по телефону +7 (701) 123-45-67 или по email ivanov@example.com.
Я родился 01.01.1990 и мне 35 лет."""
            
            anonymized = self.anonymizer.anonymize_text(sample_text)
            
            return f"""Пример анонимизации текста в SafeMind:

📋 Исходный текст:
{sample_text}

✅ Анонимизированный текст:
{anonymized}

В этом примере SafeMind обнаружил и скрыл следующие типы данных:
- ФИО (Иванов Иван Иванович → IXXX IXXX IXXX)
- ИИН (12-значный номер → XXX-XXX-XXXX)
- Телефон (номер в формате +7 → +X-XXX-XXX-XXXX)
- Email (ivanov@example.com → iXXXXXv@example.com)
- Дата рождения (01.01.1990 → XX.XX.XXXX)
- Возраст (35 лет → XX лет)

Чтобы анонимизировать свой текст, перейдите на вкладку "Текст" и следуйте инструкциям выше.

Нужна дополнительная помощь по работе с текстом?"""
    
    def blur_faces_command(self, message, current_file):
        """Информация о размытии лиц"""
        return """Размытие лиц в SafeMind - мощная функция для защиты конфиденциальности на фотографиях.

📝 Как размыть лица на изображении:

1. Перейдите на вкладку "Изображения"
2. Нажмите кнопку "Загрузить изображение" и выберите файл (поддерживаются форматы JPG, PNG, JPEG, BMP)
3. Убедитесь, что в нижней части окна включен чекбокс "Обнаружение и размытие лиц"
4. Нажмите кнопку "Анонимизировать"
5. SafeMind автоматически обнаружит все лица и размоет их, сохраняя остальную часть изображения нетронутой
6. Обработанное изображение появится в правой части окна
7. Нажмите "Сохранить изображение", чтобы сохранить результат в файл

🔍 Технические детали:
- SafeMind использует алгоритм Haar Cascade для обнаружения лиц
- Для распознавания используются как фронтальные лица, так и глаза
- Степень размытия достаточна для защиты личности, но сохраняет общее представление о фотографии
- Функция работает также на фотографиях внутри PDF-документов

💡 Совет: Для наилучших результатов используйте изображения хорошего качества, где лица видны достаточно четко.

Есть вопросы по работе с изображениями?
"""

    def functions_command(self, message, current_file):
        """Список функций приложения"""
        return """Основные функции SafeMind:

📝 Анонимизация текста:
- Обнаружение и маскирование 9 типов персональных данных, включая:
  - ИИН, телефоны, email, ФИО, банковские карты и счета
  - IBAN, даты рождения, возраст
- Выборочная анонимизация только нужных типов данных
- Быстрый режим "Скрыть личную информацию"
- Сохранение анонимизированного текста в файл

🖼️ Обработка изображений:
- Обнаружение и размытие лиц на фотографиях 
- Распознавание текста на изображениях (OCR)
- Поиск персональных данных в тексте на изображениях
- Сохранение обработанных изображений

📄 Анонимизация PDF-документов:
- Поддержка как обычных, так и сканированных PDF
- Размытие лиц на фотографиях внутри PDF
- Редактирование текста с персональными данными
- Обработка многостраничных документов
- Предпросмотр результата
- Создание нового анонимизированного PDF

📊 Отчеты:
- Детальная информация о найденных персональных данных
- Группировка по типам данных
- Указание страниц для PDF-документов
- Экспорт отчетов в текстовый файл

🤖 Чат-бот (вы сейчас используете эту функцию):
- Интеллектуальный помощник по работе с программой
- Ответы на вопросы о защите персональных данных
- Быстрые команды для популярных функций
- Контекстная помощь

Какую функцию вы хотели бы изучить подробнее?
"""

    def about_command(self, message, current_file):
        """Информация о приложении"""
        return """О программе SafeMind:

SafeMind — это специализированное программное обеспечение для анонимизации персональных данных в различных типах документов. Программа разработана для защиты конфиденциальности и соблюдения законодательства о персональных данных.

🔒 Основное назначение:
- Обнаружение и анонимизация конфиденциальной информации
- Защита от утечек персональных данных
- Подготовка документов для публичного использования
- Соблюдение требований законодательства о защите информации

💻 Технические особенности:
- Интуитивно понятный интерфейс с вкладками
- Поддержка различных типов файлов (текст, изображения, PDF)
- Использование технологий компьютерного зрения и OCR
- Регулярные выражения для точного поиска данных

🔬 Точность распознавания:
- Высокая точность обнаружения структурированных данных (ИИН, телефоны)
- Алгоритмы для распознавания лиц на изображениях
- Продвинутая обработка PDF-документов с сохранением форматирования

SafeMind постоянно совершенствуется для обеспечения более эффективной защиты ваших данных.

Нужна ли вам конкретная помощь по использованию программы?
"""

    def instruction_command(self, message, current_file):
        """Подробная инструкция по работе с программой"""
        return """📘 ИНСТРУКЦИЯ ПО РАБОТЕ С SAFEMIND

1️⃣ НАЧАЛО РАБОТЫ:
- Запустите приложение SafeMind
- В главном окне вы увидите панель с вкладками: Текст, Изображения, PDF-файлы, Отчет, Чат-бот
- Выберите вкладку в зависимости от типа данных, с которыми хотите работать

2️⃣ АНОНИМИЗАЦИЯ ТЕКСТА:
- Вкладка "Текст" → вставьте текст в верхнее поле
- Отметьте типы данных для анонимизации (ИИН, Телефон, Email и т.д.)
- Нажмите "Анонимизировать" или "Скрыть личную информацию"
- Анонимизированный текст появится в нижнем поле
- Нажмите "Сохранить результат" для экспорта в файл

3️⃣ ОБРАБОТКА ИЗОБРАЖЕНИЙ:
- Вкладка "Изображения" → "Загрузить изображение"
- Выберите типы данных для поиска в тексте изображения
- Отметьте "Обнаружение и размытие лиц", если нужно
- Нажмите "Анонимизировать"
- Результат появится справа
- Нажмите "Сохранить изображение"

4️⃣ РАБОТА С PDF:
- Вкладка "PDF-файлы" → "Загрузить PDF"
- Выберите типы данных и опцию размытия лиц
- Нажмите "Анонимизировать PDF"
- Дождитесь завершения обработки
- Используйте предпросмотр для проверки результата
- Нажмите "Сохранить анонимизированный PDF"

5️⃣ АНАЛИЗ ОТЧЕТОВ:
- После любой операции анонимизации перейдите на вкладку "Отчет"
- Просмотрите список обнаруженных персональных данных
- При необходимости сохраните отчет кнопкой "Сохранить отчет"

6️⃣ ИСПОЛЬЗОВАНИЕ ЧАТ-БОТА:
- Вкладка "Чат-бот" → введите вопрос или используйте кнопки быстрых команд
- Получите помощь по использованию программы или ответы на вопросы

7️⃣ РЕКОМЕНДАЦИИ:
- Для лучшего распознавания лиц используйте четкие изображения
- При работе с PDF убедитесь, что текст в нем распознаваемый
- Для сканированных PDF программа автоматически использует OCR
- Регулярно проверяйте результаты анонимизации

Нужна дополнительная информация по какому-либо разделу?
"""
    
    def general_response(self, message, current_file):
        """Локальные ответы для случаев, когда AI недоступен"""
        message_lower = message.lower()
        
        
        if any(word in message_lower for word in ["привет", "здравствуй", "добрый день", "добрый вечер"]):
            return f"Здравствуйте! Я виртуальный ассистент SafeMind. Чем могу помочь вам сегодня? Вы можете спросить меня о функциях приложения или о том, как защитить персональные данные."
            
        elif any(word in message_lower for word in ["что ты умеешь", "что ты можешь", "твои возможности"]):
            return self.functions_command(message, current_file)
            
        elif "персональные данные" in message_lower or "личная информация" in message_lower:
            return """В SafeMind обрабатываются следующие типы персональных данных:

- ИИН (индивидуальный идентификационный номер) - 12-значный номер
- ФИО (фамилия, имя, отчество) - полные имена людей
- Телефоны - в различных форматах, включая международные
- Email - адреса электронной почты
- Банковские карты - 16-значные номера карт
- Банковские счета - 20-значные номера счетов
- IBAN - международные банковские идентификаторы
- Даты рождения - в разных форматах (ДД.ММ.ГГГГ, ГГГГ-ММ-ДД)
- Возраст - упоминания о возрасте человека

SafeMind помогает защитить эти данные путем их анонимизации в различных типах документов, соблюдая требования законодательства о защите персональных данных.

Какие конкретно данные вам нужно защитить?"""
                
        elif "ошибка" in message_lower or "не работает" in message_lower:
            return """Рекомендации по устранению ошибок в SafeMind:

1. Проверьте установку Tesseract OCR:
   • Путь должен быть корректно указан в настройках
   • По умолчанию: C:\\Program Files\\Tesseract-OCR\\tesseract.exe

2. Убедитесь, что установлены все необходимые библиотеки:
   • OpenCV (для работы с изображениями)
   • PyMuPDF (для работы с PDF)
   • pytesseract (для распознавания текста)
   • PyQt5 (для интерфейса)

3. При проблемах с PDF:
   • Проверьте, что файл не защищен паролем
   • Для сканированных документов убедитесь, что изображение четкое

4. При проблемах с распознаванием лиц:
   • Проверьте качество и освещение на фотографии
   • Убедитесь, что лица видны фронтально

Для решения конкретной проблемы опишите ее более подробно."""
        
        elif current_file and ("анализ" in message_lower or "обработать" in message_lower or "анонимизировать" in message_lower):
            file_type = "текст"
            if current_file != "текст":
                file_ext = os.path.splitext(current_file)[1].lower()
                if file_ext in ['.jpg', '.jpeg', '.png', '.bmp']:
                    file_type = "изображение"
                elif file_ext == '.pdf':
                    file_type = "PDF-документ"
                    
            return f"""Я вижу, что вы сейчас работаете с файлом типа "{file_type}". 

Для его обработки в SafeMind:

1. Убедитесь, что вы находитесь на правильной вкладке:
   • Для текста - вкладка "Текст"
   • Для изображений - вкладка "Изображения" 
   • Для PDF - вкладка "PDF-файлы"

2. Выберите типы данных, которые нужно анонимизировать, отметив соответствующие чекбоксы

3. При работе с изображениями или PDF включите опцию "Обнаружение и размытие лиц", если требуется

4. Нажмите кнопку "Анонимизировать" (или соответствующую кнопку в зависимости от типа файла)

5. После обработки посмотрите результат и перейдите на вкладку "Отчет" для детальной информации о найденных данных

Нужна дополнительная помощь с этим файлом?"""
        
        else:
            
            responses = [
                "Я не совсем понял ваш вопрос. Не могли бы вы переформулировать его или выбрать одну из команд в меню 'Помощь'?",
                "Извините, но я не могу полноценно ответить на этот вопрос в режиме ограниченной функциональности. Попробуйте задать более конкретный вопрос о работе программы SafeMind.",
                "Для получения списка доступных команд введите 'Помощь'. Там вы найдете информацию о всех функциях SafeMind.",
                "Я специализируюсь на помощи с функциями приложения SafeMind. Спросите меня о конкретных задачах, например, 'Как анонимизировать изображение?' или 'Как работает поиск ИИН?'",
                "Я могу рассказать вам о функциях SafeMind для анонимизации данных. Для начала введите 'Функции', чтобы увидеть общий обзор возможностей программы."
            ]
            return random.choice(responses)